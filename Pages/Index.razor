@page "/"
@using BlazorInputFile
@using server.Data
@inject IFileUpload fileUpload
@inject IJSRuntime js

<p>In order for this tool to work, an "uncompressed XML" file is needed for your .als project</p>
<ol>
    <li>Make a copy of your als project file</li>
    <li>Zip the duplicate file</li>
    <li>Unzip the zipped file to get the "uncompressed XML"</li>
    <ul>
        <li>you can also double check by opening the uncompressed file in a text editor</li>
        <li>it should say <code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code> on the top of the file</li>
    </ul>
    <li>Upload that file here</li>
</ol>
<p class="disclaimer">
    DISCLAIMER: I am not liable for any damage done to your original file.
    This is why step 1 is absolutely crucial. You should still send your file to Ableton support to see if they can fix it.
    They will definitely do a much better job than this tool. 
</p>

<InputFile OnChange="HandleFileSelected"/>

<section>
@if (file is IFileListEntry && filestream is System.IO.MemoryStream)
{
    <p><b>Uploaded @file.Name</b></p>
    <div class="download">
        <p>Now click "Get New XML" to download the new (hopefully) un-corrupted file</p>
        <p>Be sure to save the file with the ".als" extension</p>
        <p>To use the tool on another file, refresh the page to start over</p>
    </div>
    <section>
        <button @onclick="@ProcessFileAsync">Get New XML</button>
    </section>
}
</section>

@code {
    private IFileListEntry file;
    private System.IO.MemoryStream filestream;
    private string result = "";

    async Task HandleFileSelected(IFileListEntry[] files)
    {
        if (files.FirstOrDefault() is IFileListEntry entry)
        {
            filestream = (System.IO.MemoryStream)await fileUpload.UploadAsync(entry);
            file = entry;
        }
    }

    async Task ProcessFileAsync()
    {
        result = await Fix.FixCorruptXmlAsync(filestream);

        await js.InvokeAsync<object>("FileSaveAs", "", result);
    }
}